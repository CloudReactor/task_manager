name: Python Checks

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Set up test database and user
      run: |
        PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE USER web WITH PASSWORD 'webpass';"
        PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE cloudreactor_task_manager_test OWNER web;"
        PGPASSWORD=postgres psql -h localhost -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE cloudreactor_task_manager_test TO web;"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.12'

    - name: Install uv
      run: |
        pip install --no-cache-dir uv==0.10.2

    - name: Install dependencies
      working-directory: ./server
      run: |
        uv sync --frozen --extra dev

    - name: Run pytest
      working-directory: ./server
      env:
        DATABASE_HOST: localhost
        DATABASE_PORT: 5432
        DJANGO_SETTINGS_MODULE: task_manager.settings
        SECRET_KEY: test-secret-key-for-ci
        IN_PYTEST: TRUE
      run: |
        uv run pytest -v

    - name: Run pylint
      working-directory: ./server
      run: |
        uv run pylint processes/ --exit-zero --rcfile=.pylintrc || true
      continue-on-error: true

    - name: Run mypy
      working-directory: ./server
      run: |
        uv run mypy processes/ --config-file=mypy_django.ini
      continue-on-error: true

    - name: Run mypy (strict)
      working-directory: ./server
      run: |
        uv run mypy processes/ --config-file=mypy.ini || true
      continue-on-error: true
